# SPHINCS+ benchmark reproduction instructions

This folder contains test data and scripts for benchmarking different SPHINCS+
configurations on OpenTitan.

You will need to first follow the general OpenTitan [setup
instructions](https://opentitan.org/guides/getting_started/index.html) to make
sure everything can build and run on your setup.
The simulations run on Verilator.

## Run the benchmarks on existing test data

To run tests for existing parameter sets, use `run_benchmark.sh`.
You will need to set the `$OT_REPO_TOP` environment variable to point to the
root of the `opentitan` repository.
For example:
```console
./run_benchmark.sh gen/params/params-sphincs-shake-n16h18d1lgt24k6w16.h logs gen/tests
```
This test runs the parameters in the `params-sphincs-shake-n16h18d1lgt24k6w16.h`
header file and writes the output into the `logs/` directory.
It looks for test data in `gen/tests/`.
If no matching test data exists, the script will try to generate new data from the reference implementation, which requires a little extra setup (see below).
Then it runs several tests on a Verilator hardware simulation.
At the end, if successful, it will print some statistics, e.g.:
```console
Number of tests: 5
Min cycle count: 1273918
Max cycle count: 1325571
Avg cycle count: 1299814
```

If you are curious for the full output, you can find it under `logs/` (or
wherever you chose to put the logs).
You can also parse any log file with the `benchmark_stats.py` script to print statistics for previous runs.

Warning: the simulation may take hours to run, depending on the parameter set.
The first run must also compile the hardware design for Verilator, which takes an hour or so on its own.
By changing `sim_verilator` to `fpga_cw310_test_rom` in the benchmark script, it would be possible to run the test on an FPGA instead, which is much faster.
However, the FPGA does not produce accurate cycle counts, which is why for benchmarks Verilator is worth the wait.

## Generate new test data from the SPHINCS+ reference

To test a new configuration:
1. Check out the SPHINCS+ [reference implementation](https://github.com/sphincs/sphincsplus). The existing test data was generated from commit `035b39`. Ensure you can run `make` and successfully build the test data.
1. Generate a new parameter header file (like the ones under `gen/params`) using
   `make_ref_header.py`. Use `--help` to see more usage details. This script
   requires a "template" header file to change the parameters of, which should
   be any parameters header file from the SPHINCS+ reference implementation that
   uses the SHAKE as the hash function.
1. Set the `$OT_REPO_TOP` environment variable to the root of the `opentitan`
   repository, and set the `SPX_REPO_TOP` environment variable to the root of
   the `sphincsplus` repository.
1. Run the `run_benchmark.sh` script using your new parameter file. This script
   will automatically generate new test data if it can't find any in the test
   data directory. ALternatively, you can run the `make_test_data.sh` script
   directly.

Note: By default, the SPHINCS+ reference implementation will generate 100 test
vectors, but `run_benchmark.sh` will only actually run 5 benchmarks.
To save time, especially for parameter sets where signing is slow, you can
manually reduce the number of test vectors generated by editing
`ref/PQCgenKAT_sign.c` in the reference implementation.

## Classical cryptography benchmarks

To compare numbers for RSA-3072 and ECDSA-P256, run the following tests via
Bazel from the top of the `opentitan` repo:
```
bazel test --test_output=streamed //sw/device/silicon_creator/lib/sigverify:mod_exp_otbn_functest_hardcoded_sim_verilator
bazel test --test_output=streamed //sw/device/tests/crypto:ecdsa_p256_verify_functest_hardcoded_sim_verilator
```

In both cases, only the first test is testing a valid signature.
Other tests use invalid signatures, so their cycle counts should not be included in the benchmark.
